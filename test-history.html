<!DOCTYPE html>
<html>
<head>
  <title>Test History Viewer</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
    .session-card { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px; cursor: pointer; }
    .session-card:hover { background: #f5f5f5; }
    .result-viewer { margin-top: 20px; padding: 20px; background: #f9f9f9; border-radius: 8px; max-height: 600px; overflow-y: auto; }
    .loading { color: blue; }
    .error { color: red; }
    pre { white-space: pre-wrap; word-wrap: break-word; }
  </style>
</head>
<body>
  <h1>ðŸ“š Research History Viewer Test</h1>
  <div id="sessions"></div>
  <div id="result"></div>

  <script>
    async function loadHistory() {
      try {
        const response = await fetch('/api/history');
        const sessions = await response.json();
        console.log('Sessions loaded:', sessions.length);
        
        const container = document.getElementById('sessions');
        container.innerHTML = '<h2>Research Sessions (' + sessions.length + ')</h2>';
        
        sessions.forEach((session, index) => {
          const card = document.createElement('div');
          card.className = 'session-card';
          card.innerHTML = `
            <strong>${index + 1}. ${session.query.substring(0, 60)}...</strong><br>
            <small>Status: ${session.status} | Type: ${session.type} | Date: ${new Date(session.createdAt).toLocaleString()}</small><br>
            <small>Result: ${session.result ? session.result.length + ' chars' : 'No result'}</small>
          `;
          card.onclick = () => viewResult(session.id);
          container.appendChild(card);
        });
      } catch (error) {
        document.getElementById('sessions').innerHTML = '<p class="error">Error: ' + error.message + '</p>';
      }
    }

    async function viewResult(sessionId) {
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = '<p class="loading">Loading result...</p>';
      
      try {
        const response = await fetch(`/api/history/${sessionId}`);
        const session = await response.json();
        
        console.log('Session loaded:', session.status, 'Has result:', !!session.result);
        
        if (session.result) {
          resultDiv.innerHTML = `
            <div class="result-viewer">
              <h2>ðŸ“„ Research Result</h2>
              <p><strong>Query:</strong> ${session.query}</p>
              <p><strong>Status:</strong> ${session.status}</p>
              <hr>
              <pre>${session.result.substring(0, 3000)}...</pre>
              <p><em>(Showing first 3000 characters of ${session.result.length} total)</em></p>
              <button onclick="downloadResult('${sessionId}')">Download Full Result</button>
            </div>
          `;
        } else {
          resultDiv.innerHTML = '<p class="error">No result available for this session</p>';
        }
      } catch (error) {
        resultDiv.innerHTML = '<p class="error">Error loading session: ' + error.message + '</p>';
      }
    }

    async function downloadResult(sessionId) {
      const response = await fetch(`/api/history/${sessionId}`);
      const session = await response.json();
      
      const blob = new Blob([session.result], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `research-${sessionId}.md`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Load history on page load
    loadHistory();
  </script>
</body>
</html>
